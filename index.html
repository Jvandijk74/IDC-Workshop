import React, { useState, useEffect } from 'react';
import { Play, Pause, RotateCcw, ChevronRight, ChevronDown, Clock, Check, Lightbulb, Clipboard } from 'lucide-react';

const WorkshopFacilitator = () => {
  const [currentDay, setCurrentDay] = useState(1);
  const [expandedActivity, setExpandedActivity] = useState(null);
  const [timerActive, setTimerActive] = useState(false);
  const [timeRemaining, setTimeRemaining] = useState(0);
  const [completedActivities, setCompletedActivities] = useState(new Set());
  const [notes, setNotes] = useState({});
  const [visionStatements, setVisionStatements] = useState([]);

  const day1Activities = [
    {
      id: 1,
      title: "Quiz Card",
      duration: 20,
      description: "Get to know each other better with quiz cards",
      prep: [
        "Print quiz cards or prepare digital version",
        "Have a visible timer ready"
      ],
      details: [
        "Question 1: What was your first job?",
        "Question 2: A song that you enjoy from your childhood?",
        "Question 3: What is something you're proud of?"
      ],
      facilitation: [
        "Go around the room, each person shares one question at a time",
        "Keep energy high and encourage storytelling",
        "Time management: ~6-7 min per question"
      ]
    },
    {
      id: 2,
      title: "Personal Timeline",
      duration: 30,
      description: "Share highs and lows from the last year",
      prep: [
        "Prepare a timeline on the wall/board (Jan-Dec)",
        "Have sticky notes and pens ready for each person",
        "Different colored sticky notes for highs (green) and lows (red)"
      ],
      details: [
        "Grab a sticky note for your timeline",
        "Mark your highs and lows across the months",
        "Share with the team"
      ],
      facilitation: [
        "Give 5 min for individual reflection and writing",
        "Each person places their sticky notes on the timeline",
        "Share stories - 2-3 min per person",
        "Look for patterns across the team"
      ]
    },
    {
      id: 3,
      title: "Retrospective",
      duration: 60,
      description: "Reflect on the past year",
      prep: [
        "Create three sections on board/wall: 'I like', 'I wish', 'I wonder'",
        "Sticky notes (3 colors preferred) and pens for everyone",
        "Timer visible to all"
      ],
      details: [
        "I like... (What went well)",
        "I wish... (What could be improved)",
        "I wonder... (Questions for the future)"
      ],
      facilitation: [
        "Silent writing: 10 min - everyone writes sticky notes",
        "Posting: 5 min - place notes on board",
        "Grouping: 10 min - group similar themes together as a team",
        "Discussion: 30-35 min - discuss themes, starting with 'I like'",
        "Capture action items and insights in notes section"
      ]
    },
    {
      id: 4,
      title: "Product Vision",
      duration: 90,
      description: "Define the product vision and strategy",
      prep: [
        "Prepare your PO presentation (customer, problem, context)",
        "Large sheets/board space for vision work",
        "Sticky notes and markers",
        "Vision statement templates printed or visible"
      ],
      steps: [
        {
          step: 1,
          title: "Product Owner Shares Vision",
          items: ["Who is the customer", "What does IDC solve", "Additional strategic context"],
          facilitation: "Take 15-20 min to present. Be clear and inspiring. Allow questions."
        },
        {
          step: 2,
          title: "Create Shared Team Vision",
          prompt: "What is the ultimate impact our product should achieve for our users and stakeholders in the next 2-3 years?",
          activity: ["1-2-4-All", "1 Minute alone", "2 Minutes in pairs", "4 Group of 4", "All together"],
          facilitation: "Strictly time each phase. Encourage building on each other's ideas."
        },
        {
          step: 3,
          title: "Identify Recurring Themes",
          description: "What patterns emerge from our discussion?",
          facilitation: "Write themes on board. Look for: customer impact, team values, product differentiation."
        },
        {
          step: 4,
          title: "Draft Vision Statement",
          options: [
            "Option 1: We help [target user] achieve [benefit] by [how product creates value]",
            "Option 2: Our product will [impact] so that [greater purpose]"
          ],
          activity: ["In pairs (5-10 minutes)", "In the group (10 minutes)", "Use best of all and draft it together"],
          facilitation: "Keep it concise (1-2 sentences). Make it inspiring. Ensure buy-in from everyone."
        }
      ]
    },
    {
      id: 5,
      title: "Team Name",
      duration: 30,
      description: "Choose a team name",
      prep: [
        "Clear board space for brainstorming",
        "Markers or digital whiteboard ready"
      ],
      details: ["Brainstorm ideas", "Vote on favorites", "Decide together"],
      facilitation: [
        "Open brainstorm: 10 min - all ideas welcome",
        "Narrow down: 10 min - discuss top 5-7",
        "Vote: Use dot voting or consensus",
        "Make it fun and inclusive!"
      ]
    }
  ];

  const day2Activities = [
    {
      id: 6,
      title: "Retrospect Yesterday",
      duration: 20,
      description: "Reflect on Day 1 learnings",
      prep: [
        "Review your notes from Day 1",
        "Have sticky notes ready"
      ],
      details: [
        "What did you take from yesterday's session?",
        "What would you like to get out of today's session?"
      ],
      facilitation: [
        "Quick round robin - 2 min per person",
        "Capture themes on board",
        "Use this to adjust Day 2 if needed"
      ]
    },
    {
      id: 7,
      title: "Team Construction",
      duration: 60,
      description: "Create team agreements based on shared values",
      prep: [
        "Create 3 sections in room with labels: 'Common ground', 'Diverse needs', 'Surprises'",
        "Lots of sticky notes in different colors",
        "Large sheets for final agreements"
      ],
      reflection: {
        prompt: "To do my best work, I need...",
        categories: [
          "Communication: How or when do I need to be informed? What is my preferred communication style?",
          "Collaboration: What helps me work well with others? What disrupts my flow?",
          "Feedback: How do I want to receive feedback? How often?",
          "Support: When I'm stuck, what do I need?",
          "Boundaries: What are my non-negotiables? (meeting times, focus hours, response times)"
        ]
      },
      steps: [
        "Individual reflection (10 min) - write on sticky notes",
        "Discuss in groups of 3 or 4 (15 min)",
        "Find patterns: What came up multiple times? What are our shared values? (10 min)",
        "Determine main differences (5 min)",
        "Place sticky notes in room sections (5 min)",
        "Create 3-5 team agreements starting with 'We agree that...' (15 min)"
      ],
      facilitation: [
        "Encourage honesty and vulnerability",
        "Ensure all voices are heard",
        "Focus on actionable agreements",
        "Document agreements - take photo or write in notes"
      ]
    },
    {
      id: 8,
      title: "Event Optimizer",
      duration: 60,
      description: "Improve scrum events",
      prep: [
        "List of current scrum events visible",
        "Space for teams to work in groups of 2-3",
        "Paper/boards for each team"
      ],
      events: [
        "Daily",
        "Sprint Planning",
        "Refinement",
        "Retrospective"
      ],
      details: [
        "In teams of two or three, choose one event",
        "Make 10 minute agenda per event and add improvements we can make",
        "Discuss and accept as team"
      ],
      facilitation: [
        "Divide team into 2-3 person groups",
        "Each group picks different event (or same if small team)",
        "Work time: 20-25 min",
        "Presentations: 5-7 min per group",
        "Team discussion & acceptance: 15-20 min",
        "Ask: What works? What concerns do we have? What will we try?"
      ]
    },
    {
      id: 9,
      title: "Definition of Done",
      duration: 60,
      description: "Define what 'done' means for the team",
      prep: [
        "Print or display DoD categories table",
        "Organize sticky notes by category (Code Quality, Testing, Documentation, etc.)",
        "Large board space for organizing notes",
        "Confluence or documentation tool open to capture final DoD"
      ],
      categories: [
        "Code Quality",
        "Testing",
        "Documentation",
        "Security",
        "Deployment/Release",
        "Performance"
      ],
      guidingQuestions: [
        "What feels outdated?",
        "What's missing that we always do anyway?",
        "What should we add to raise quality?"
      ],
      steps: [
        "Review current DoD and question (10 min): a) What feels outdated, b) What can make our work more mature, c) What can make our work of better quality, d) What can be improved on the previous DoD",
        "Which DoD categories do we need? (quick discussion)",
        "Discuss in teams of two (15 min)",
        "Share top 5 suggestions on board (5 min)",
        "Align and discuss (40 min): a) Order by theme, b) Vote, c) Rewrite and agree together on Confluence"
      ],
      facilitation: [
        "Start with current DoD review - be critical",
        "Encourage specific, measurable criteria",
        "Focus on quality, not just checkboxes",
        "Ensure DoD is realistic and achievable",
        "Get explicit agreement from everyone",
        "Remind: DoD should be living document, reviewed regularly"
      ]
    }
  ];

  const allActivities = currentDay === 1 ? day1Activities : day2Activities;

  useEffect(() => {
    let interval;
    if (timerActive && timeRemaining > 0) {
      interval = setInterval(() => {
        setTimeRemaining(prev => {
          if (prev <= 1) {
            setTimerActive(false);
            return 0;
          }
          return prev - 1;
        });
      }, 1000);
    }
    return () => clearInterval(interval);
  }, [timerActive, timeRemaining]);

  const startTimer = (minutes) => {
    setTimeRemaining(minutes * 60);
    setTimerActive(true);
  };

  const toggleTimer = () => setTimerActive(!timerActive);
  
  const resetTimer = (minutes) => {
    setTimeRemaining(minutes * 60);
    setTimerActive(false);
  };

  const formatTime = (seconds) => {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins}:${secs.toString().padStart(2, '0')}`;
  };

  const toggleComplete = (id) => {
    const newCompleted = new Set(completedActivities);
    if (newCompleted.has(id)) {
      newCompleted.delete(id);
    } else {
      newCompleted.add(id);
    }
    setCompletedActivities(newCompleted);
  };

  const updateNotes = (id, value) => {
    setNotes(prev => ({ ...prev, [id]: value }));
  };

  const addVisionStatement = () => {
    setVisionStatements([...visionStatements, { text: '', author: '' }]);
  };

  const updateVisionStatement = (index, field, value) => {
    const updated = [...visionStatements];
    updated[index][field] = value;
    setVisionStatements(updated);
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-purple-50 via-pink-50 to-blue-50">
      {/* Header */}
      <div className="bg-white shadow-sm border-b border-gray-200">
        <div className="max-w-7xl mx-auto px-6 py-4">
          <div className="flex items-center justify-between">
            <div>
              <h1 className="text-3xl font-bold text-gray-900">IDC Team Workshop</h1>
              <p className="text-gray-600 mt-1">Product Owner Facilitation Tool</p>
            </div>
            <div className="flex gap-3">
              <button
                onClick={() => setCurrentDay(1)}
                type="button"
                className={`px-6 py-2 rounded-lg font-medium transition-all ${
                  currentDay === 1
                    ? 'bg-purple-600 text-white shadow-lg'
                    : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                }`}
              >
                Day 1
              </button>
              <button
                onClick={() => setCurrentDay(2)}
                type="button"
                className={`px-6 py-2 rounded-lg font-medium transition-all ${
                  currentDay === 2
                    ? 'bg-purple-600 text-white shadow-lg'
                    : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                }`}
              >
                Day 2
              </button>
            </div>
          </div>
        </div>
      </div>

      <div className="max-w-7xl mx-auto px-6 py-8">
        {/* Timer Widget */}
        {timeRemaining > 0 && (
          <div className="mb-6 bg-white rounded-2xl shadow-lg p-6 border-2 border-purple-200">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-4">
                <Clock className="w-8 h-8 text-purple-600" />
                <div>
                  <p className="text-sm text-gray-600">Active Timer</p>
                  <p className={`text-4xl font-bold ${timeRemaining < 60 ? 'text-red-600' : 'text-purple-600'}`}>
                    {formatTime(timeRemaining)}
                  </p>
                </div>
              </div>
              <div className="flex gap-2">
                <button
                  onClick={toggleTimer}
                  type="button"
                  className="p-3 bg-purple-100 hover:bg-purple-200 rounded-lg transition-colors"
                >
                  {timerActive ? <Pause className="w-6 h-6 text-purple-600" /> : <Play className="w-6 h-6 text-purple-600" />}
                </button>
                <button
                  onClick={() => setTimeRemaining(0)}
                  type="button"
                  className="p-3 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors"
                >
                  <RotateCcw className="w-6 h-6 text-gray-600" />
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Progress Bar */}
        <div className="mb-8 bg-white rounded-2xl shadow-sm p-6">
          <div className="flex items-center justify-between mb-3">
            <p className="text-sm font-medium text-gray-700">Day {currentDay} Progress</p>
            <p className="text-sm text-gray-600">
              {Array.from(completedActivities).filter(id => 
                allActivities.some(act => act.id === id)
              ).length} / {allActivities.length} completed
            </p>
          </div>
          <div className="w-full bg-gray-200 rounded-full h-3">
            <div
              className="bg-gradient-to-r from-purple-600 to-pink-600 h-3 rounded-full transition-all duration-500"
              style={{ width: `${(Array.from(completedActivities).filter(id => 
                allActivities.some(act => act.id === id)
              ).length / allActivities.length) * 100}%` }}
            />
          </div>
        </div>

        {/* Activities */}
        <div className="space-y-4">
          {allActivities.map((activity, index) => (
            <div
              key={activity.id}
              className={`bg-white rounded-2xl shadow-sm hover:shadow-md transition-all border-2 ${
                completedActivities.has(activity.id) ? 'border-green-300 bg-green-50' : 'border-transparent'
              }`}
            >
              <div
                className="p-6 cursor-pointer"
                onClick={() => setExpandedActivity(expandedActivity === activity.id ? null : activity.id)}
              >
                <div className="flex items-start justify-between">
                  <div className="flex items-start gap-4 flex-1">
                    <div className="flex-shrink-0">
                      <div className="w-12 h-12 bg-gradient-to-br from-purple-500 to-pink-500 rounded-xl flex items-center justify-center text-white font-bold text-lg">
                        {index + 1}
                      </div>
                    </div>
                    <div className="flex-1">
                      <div className="flex items-center gap-3">
                        <h3 className="text-xl font-bold text-gray-900">{activity.title}</h3>
                        <span className="px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-sm font-medium flex items-center gap-1">
                          <Clock className="w-4 h-4" />
                          {activity.duration} min
                        </span>
                      </div>
                      <p className="text-gray-600 mt-1">{activity.description}</p>
                    </div>
                  </div>
                  <div className="flex items-center gap-3">
                    <button
                      onClick={(e) => {
                        e.stopPropagation();
                        toggleComplete(activity.id);
                      }}
                      type="button"
                      className={`p-2 rounded-lg transition-all ${
                        completedActivities.has(activity.id)
                          ? 'bg-green-500 text-white'
                          : 'bg-gray-100 text-gray-400 hover:bg-gray-200'
                      }`}
                    >
                      <Check className="w-5 h-5" />
                    </button>
                    {expandedActivity === activity.id ? (
                      <ChevronDown className="w-6 h-6 text-gray-400" />
                    ) : (
                      <ChevronRight className="w-6 h-6 text-gray-400" />
                    )}
                  </div>
                </div>
              </div>

              {expandedActivity === activity.id && (
                <div className="px-6 pb-6 space-y-4 border-t border-gray-100 pt-4">
                  {/* Preparation Checklist */}
                  {activity.prep && (
                    <div className="bg-blue-50 border-l-4 border-blue-500 rounded-lg p-4">
                      <div className="flex items-center gap-2 mb-3">
                        <Clipboard className="w-5 h-5 text-blue-600" />
                        <h4 className="font-bold text-blue-900">Preparation Checklist</h4>
                      </div>
                      <ul className="space-y-2">
                        {activity.prep.map((item, i) => (
                          <li key={i} className="flex items-start gap-2 text-blue-900">
                            <span className="text-blue-600 mt-1">□</span>
                            <span>{item}</span>
                          </li>
                        ))}
                      </ul>
                    </div>
                  )}

                  {/* Timer Controls */}
                  <div className="flex gap-2">
                    <button
                      onClick={() => startTimer(activity.duration)}
                      type="button"
                      className="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors flex items-center gap-2"
                    >
                      <Play className="w-4 h-4" />
                      Start Timer
                    </button>
                    <button
                      onClick={() => resetTimer(activity.duration)}
                      type="button"
                      className="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors flex items-center gap-2"
                    >
                      <RotateCcw className="w-4 h-4" />
                      Reset
                    </button>
                  </div>

                  {/* Reflection Prompt */}
                  {activity.reflection && (
                    <div className="bg-amber-50 rounded-lg p-4">
                      <h4 className="font-bold text-amber-900 mb-2">Reflection Prompt:</h4>
                      <p className="text-amber-900 italic mb-3">"{activity.reflection.prompt}"</p>
                      <div className="space-y-2">
                        {activity.reflection.categories.map((cat, i) => (
                          <p key={i} className="text-sm text-amber-800">• {cat}</p>
                        ))}
                      </div>
                    </div>
                  )}

                  {/* Activity Details */}
                  {activity.details && (
                    <div className="bg-purple-50 rounded-lg p-4">
                      <h4 className="font-semibold text-gray-900 mb-2">Activity Details:</h4>
                      <ul className="space-y-2">
                        {activity.details.map((detail, i) => (
                          <li key={i} className="flex items-start gap-2 text-gray-700">
                            <span className="text-purple-600 mt-1">•</span>
                            <span>{detail}</span>
                          </li>
                        ))}
                      </ul>
                    </div>
                  )}

                  {/* Events List */}
                  {activity.events && (
                    <div className="bg-purple-50 rounded-lg p-4">
                      <h4 className="font-semibold text-gray-900 mb-2">Scrum Events to Review:</h4>
                      <ul className="space-y-1">
                        {activity.events.map((event, i) => (
                          <li key={i} className="text-gray-700">• {event}</li>
                        ))}
                      </ul>
                    </div>
                  )}

                  {/* Categories */}
                  {activity.categories && (
                    <div className="bg-purple-50 rounded-lg p-4">
                      <h4 className="font-semibold text-gray-900 mb-2">DoD Categories:</h4>
                      <div className="grid grid-cols-2 gap-2">
                        {activity.categories.map((cat, i) => (
                          <div key={i} className="bg-white rounded px-3 py-2 text-gray-700 text-sm">
                            {cat}
                          </div>
                        ))}
                      </div>
                    </div>
                  )}

                  {/* Guiding Questions */}
                  {activity.guidingQuestions && (
                    <div className="bg-yellow-50 rounded-lg p-4">
                      <h4 className="font-semibold text-gray-900 mb-2">Ask the Team:</h4>
                      <ul className="space-y-2">
                        {activity.guidingQuestions.map((q, i) => (
                          <li key={i} className="text-gray-700 italic">• {q}</li>
                        ))}
                      </ul>
                    </div>
                  )}

                  {/* Steps */}
                  {activity.steps && !activity.steps[0].step && (
                    <div className="bg-purple-50 rounded-lg p-4">
                      <h4 className="font-semibold text-gray-900 mb-2">Steps:</h4>
                      <ol className="space-y-2">
                        {activity.steps.map((step, i) => (
                          <li key={i} className="text-gray-700">
                            <span className="font-medium">{i + 1}.</span> {step}
                          </li>
                        ))}
                      </ol>
                    </div>
                  )}

                  {/* Steps for Product Vision / Complex Activities */}
                  {activity.steps && activity.steps[0].step && (
                    <div className="space-y-4">
                      {activity.steps.map((step) => (
                        <div key={step.step} className="bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg p-4">
                          <div className="flex items-center gap-2 mb-3">
                            <span className="w-8 h-8 bg-purple-600 text-white rounded-full flex items-center justify-center font-bold text-sm">
                              {step.step}
                            </span>
                            <h4 className="font-bold text-gray-900">{step.title}</h4>
                          </div>
                          {step.items && (
                            <ul className="space-y-1 ml-10">
                              {step.items.map((item, i) => (
                                <li key={i} className="text-gray-700">• {item}</li>
                              ))}
                            </ul>
                          )}
                          {step.prompt && (
                            <p className="ml-10 text-gray-700 italic">"{step.prompt}"</p>
                          )}
                          {step.activity && (
                            <div className="ml-10 mt-2 space-y-1">
                              {step.activity.map((act, i) => (
                                <p key={i} className="text-gray-700">→ {act}</p>
                              ))}
                            </div>
                          )}
                          {step.description && (
                            <p className="ml-10 text-gray-700">{step.description}</p>
                          )}
                          {step.options && (
                            <div className="ml-10 mt-2 space-y-2">
                              {step.options.map((option, i) => (
                                <div key={i} className="bg-white rounded-lg p-3">
                                  <p className="text-gray-800 font-medium">{option}</p>
                                </div>
                              ))}
                            </div>
                          )}
                          {step.facilitation && (
                            <div className="ml-10 mt-3 bg-green-50 rounded p-3">
                              <div className="flex items-center gap-2 mb-1">
                                <Lightbulb className="w-4 h-4 text-green-600" />
                                <span className="text-sm font-semibold text-green-900">Facilitation Tip:</span>
                              </div>
                              <p className="text-sm text-green-800">{step.facilitation}</p>
                            </div>
                          )}
                        </div>
                      ))}
                    </div>
                  )}

                  {/* Facilitation Tips */}
                  {activity.facilitation && (
                    <div className="bg-green-50 border-l-4 border-green-500 rounded-lg p-4">
                      <div className="flex items-center gap-2 mb-3">
                        <Lightbulb className="w-5 h-5 text-green-600" />
                        <h4 className="font-bold text-green-900">Facilitation Tips</h4>
                      </div>
                      <ul className="space-y-2">
                        {activity.facilitation.map((tip, i) => (
                          <li key={i} className="flex items-start gap-2 text-green-900">
                            <span className="text-green-600 mt-1">→</span>
                            <span>{tip}</span>
                          </li>
                        ))}
                      </ul>
                    </div>
                  )}

                  {/* Notes Section */}
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Facilitator Notes & Insights:
                    </label>
                    <textarea
                      value={notes[activity.id] || ''}
                      onChange={(e) => updateNotes(activity.id, e.target.value)}
                      placeholder="Capture key insights, themes, decisions, or action items..."
                      className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600 focus:border-transparent"
                      rows="4"
                    />
                  </div>
                </div>
              )}
            </div>
          ))}
        </div>

        {/* Vision Statement Builder - Only show on Day 1 */}
        {currentDay === 1 && (
          <div className="mt-8 bg-white rounded-2xl shadow-sm p-6">
            <h3 className="text-xl font-bold text-gray-900 mb-4">Vision Statements Captured</h3>
            <div className="space-y-3">
              {visionStatements.map((statement, index) => (
                <div key={index} className="flex gap-3">
                  <input
                    type="text"
                    placeholder="Team member name..."
                    value={statement.author}
                    onChange={(e) => updateVisionStatement(index, 'author', e.target.value)}
                    className="w-40 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600 focus:border-transparent"
                  />
                  <input
                    type="text"
                    placeholder="Vision statement..."
                    value={statement.text}
                    onChange={(e) => updateVisionStatement(index, 'text', e.target.value)}
                    className="flex-1 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600 focus:border-transparent"
                  />
                </div>
              ))}
            </div>
            <button
              onClick={addVisionStatement}
              type="button"
              className="mt-3 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors"
            >
              + Add Vision Statement
            </button>
          </div>
        )}
      </div>
    </div>
  );
};

export default WorkshopFacilitator;